<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - GameHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Import Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getAuth, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            collection,
            query,
            where,
            getDocs,
            updateDoc,
            increment,
            addDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDhySV3lXOlCQ8fMIYRlzs0YpMg6MZ_Ixo",
            authDomain: "gamehub-e45ea.firebaseapp.com",
            projectId: "gamehub-e45ea",
            storageBucket: "gamehub-e45ea.firebasestorage.app",
            messagingSenderId: "609288909968",
            appId: "1:609288909968:web:45f3716ce6b2d4970d1415"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Exposer l'auth et db globalement pour les fonctions
        window.auth = auth;
        window.db = db;
        // CORRECTION : Exposer signOut directement
        window.firebaseSignOut = signOut;
        window.firebaseFirestore = {
            doc,
            getDoc,
            collection,
            query,
            where,
            getDocs,
            updateDoc,
            increment,
            addDoc,
            onSnapshot
        };
        
        // Fonction pour calculer les frais de retrait selon les paliers
        window.calculateWithdrawalFee = function(amount) {
            if (amount >= 1000 && amount <= 9999) {
                return 250; // 250F pour 1.000 √† 9.999F
            } else if (amount >= 10000 && amount <= 49999) {
                return 500; // 500F pour 10.000 √† 49.999F
            } else if (amount >= 50000 && amount <= 99999) {
                return 1000; // 1.000F pour 50.000 √† 99.999F
            } else if (amount >= 100000 && amount <= 300000) {
                return 2500; // 2.500F pour 100.000 √† 300.000F
            } else {
                return 0; // Pas de frais pour les montants en dehors des paliers
            }
        };
        
        // Fonction pour r√©cup√©rer les donn√©es utilisateur
        window.getUserData = async function(uid) {
            try {
                const userDocRef = doc(db, 'users', uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    return userDoc.data();
                } else {
                    console.log('Aucun document utilisateur trouv√©');
                    return null;
                }
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration des donn√©es utilisateur:', error);
                return null;
            }
        };
        
        // Fonction pour compter le nombre de filleuls
        window.countUserReferrals = async function(referralCode) {
            try {
                if (!referralCode) return 0;
                
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('referredBy', '==', referralCode));
                const querySnapshot = await getDocs(q);
                
                return querySnapshot.size;
            } catch (error) {
                console.error('Erreur lors du comptage des filleuls:', error);
                return 0;
            }
        };
        
        // Fonction pour calculer les gains du parrainage (30% de chaque achat des filleuls)
        window.getUserEarnings = async function(referralCode) {
            try {
                if (!referralCode) return { totalEarnings: 0, availableEarnings: 0 };
                
                let totalEarnings = 0;
                let availableEarnings = 0;
                
                // R√©cup√©rer les filleuls
                const usersRef = collection(db, 'users');
                const qUsers = query(usersRef, where('referredBy', '==', referralCode));
                const usersSnapshot = await getDocs(qUsers);
                
                // Pour chaque filleul, r√©cup√©rer ses achats
                for (const userDoc of usersSnapshot.docs) {
                    const filleulId = userDoc.id;
                    
                    // R√©cup√©rer les achats du filleul
                    const purchasesRef = collection(db, 'purchases');
                    const qPurchases = query(purchasesRef, where('userId', '==', filleulId));
                    const purchasesSnapshot = await getDocs(qPurchases);
                    
                    purchasesSnapshot.forEach(purchaseDoc => {
                        const purchaseData = purchaseDoc.data();
                        // 30% de commission sur chaque achat
                        const commission = purchaseData.price * 0.3;
                        totalEarnings += commission;
                        availableEarnings += commission; // 100% disponibles imm√©diatement
                    });
                }
                
                return {
                    totalEarnings: totalEarnings,
                    availableEarnings: availableEarnings
                };
            } catch (error) {
                console.error('Erreur lors du calcul des gains:', error);
                return {
                    totalEarnings: 0,
                    availableEarnings: 0
                };
            }
        };
        
        // Fonction pour calculer le total des retraits d√©j√† effectu√©s (avec frais)
        // CORRIG√âE : n'inclut pas les retraits rejet√©s
        window.getTotalWithdrawals = async function(userId) {
            try {
                const withdrawalsRef = collection(db, 'withdrawals');
                const q = query(withdrawalsRef, where('userId', '==', userId));
                const querySnapshot = await getDocs(q);
                
                let totalWithdrawn = 0;
                querySnapshot.forEach(doc => {
                    const withdrawalData = doc.data();
                    // N'inclure que les retraits qui ne sont pas rejet√©s
                    if (withdrawalData.status !== 'rejected') {
                        totalWithdrawn += withdrawalData.totalAmount || 0;
                    }
                });
                
                return totalWithdrawn;
            } catch (error) {
                console.error('Erreur lors du calcul des retraits:', error);
                return 0;
            }
        };
        
        // Fonction pour r√©cup√©rer les stats de l'utilisateur (CORRIG√âE)
        window.getUserStats = async function(userId, userData) {
            try {
                const referralsCount = await window.countUserReferrals(userData.referralCode);
                const earnings = await window.getUserEarnings(userData.referralCode);
                const totalWithdrawn = await window.getTotalWithdrawals(userId);
                
                // Le solde disponible = total des commissions - total des retraits d√©j√† effectu√©s (avec frais)
                const availableEarnings = Math.max(0, earnings.totalEarnings - totalWithdrawn);
                
                return {
                    referralsCount: referralsCount,
                    totalEarnings: earnings.totalEarnings,
                    availableEarnings: availableEarnings
                };
            } catch (error) {
                console.error('Erreur lors du calcul des stats:', error);
                return {
                    referralsCount: 0,
                    totalEarnings: 0,
                    availableEarnings: 0
                };
            }
        };
        
        // Fonction pour rafra√Æchir les stats silencieusement (sans notification)
        window.refreshUserStatsSilent = async function() {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                const userData = await window.getUserData(user.uid);
                if (userData) {
                    const userStats = await window.getUserStats(user.uid, userData);
                    updateUserStats(userStats);
                }
            } catch (error) {
                console.error('Erreur lors du rafra√Æchissement silencieux des stats:', error);
            }
        };
        
        // Fonction pour √©couter les changements de statut des retraits
        window.listenToWithdrawalStatus = function(userId) {
            try {
                const withdrawalsRef = collection(db, 'withdrawals');
                const q = query(withdrawalsRef, where('userId', '==', userId));
                
                // √âcouter les changements en temps r√©el
                return onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'modified') {
                            const withdrawalData = change.doc.data();
                            const withdrawalId = change.doc.id;
                            
                            // V√©rifier si le statut est pass√© √† "rejected"
                            if (withdrawalData.status === 'rejected' && !withdrawalData.balanceRestored) {
                                // Restaurer le solde de l'utilisateur
                                await window.restoreRejectedWithdrawal(userId, withdrawalId, withdrawalData);
                            }
                            
                            // V√©rifier si le statut est pass√© √† "completed"
                            if (withdrawalData.status === 'completed' && withdrawalData.notified !== true) {
                                // Notifier l'utilisateur que le retrait a √©t√© trait√©
                                showNotification(
                                    'Retrait trait√©',
                                    `Votre retrait de ${withdrawalData.netAmount.toLocaleString()}Fr a √©t√© envoy√© √† votre compte ${getMethodName(withdrawalData.method)}.`,
                                    'success',
                                    5000
                                );
                                
                                // Marquer comme notifi√©
                                await updateDoc(doc(db, 'withdrawals', withdrawalId), {
                                    notified: true
                                });
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Erreur lors de l\'√©coute des statuts de retrait:', error);
            }
        };
        
        // Fonction pour restaurer le solde lors du rejet d'un retrait
        window.restoreRejectedWithdrawal = async function(userId, withdrawalId, withdrawalData) {
            try {
                const userDocRef = doc(db, 'users', userId);
                const withdrawalDocRef = doc(db, 'withdrawals', withdrawalId);
                
                // R√©cup√©rer le document utilisateur actuel
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) {
                    throw new Error('Utilisateur non trouv√©');
                }
                
                // Calculer le montant total √† restaurer (montant + frais)
                const totalToRestore = withdrawalData.totalAmount || (withdrawalData.netAmount + withdrawalData.fee);
                
                // Restaurer le montant dans le solde de l'utilisateur
                await updateDoc(userDocRef, {
                    availableEarnings: increment(totalToRestore)
                });
                
                // Marquer le retrait comme ayant √©t√© restaur√©
                await updateDoc(withdrawalDocRef, {
                    balanceRestored: true,
                    restoredAt: new Date().toISOString(),
                    restoredAmount: totalToRestore
                });
                
                // Afficher une notification √† l'utilisateur
                showNotification(
                    'Retrait rejet√©',
                    `Votre demande de retrait de ${withdrawalData.netAmount.toLocaleString()}Fr a √©t√© rejet√©e. Le montant total de ${totalToRestore.toLocaleString()}Fr (incluant les frais) a √©t√© restaur√© √† votre solde.`,
                    'warning',
                    6000
                );
                
                // Rafra√Æchir les stats
                setTimeout(() => {
                    window.refreshUserStats();
                }, 1000);
                
                return { success: true, restoredAmount: totalToRestore };
                
            } catch (error) {
                console.error('Erreur lors de la restauration du solde:', error);
                showNotification(
                    'Erreur',
                    'Une erreur est survenue lors de la restauration de votre solde. Veuillez contacter le support.',
                    'error',
                    5000
                );
                throw error;
            }
        };
        
        // FONCTION AM√âLIOR√âE : Compter les notifications non lues
        window.countUnreadNotifications = async function(userId) {
            try {
                const notificationsRef = collection(db, 'notifications');
                
                // 1. R√©cup√©rer les notifications personnelles non lues
                const qUser = query(
                    notificationsRef,
                    where('target', '==', userId),
                    where('read', '==', false)
                );
                
                // 2. R√©cup√©rer toutes les notifications globales
                const qAll = query(
                    notificationsRef,
                    where('target', '==', 'all')
                );
                
                const [userSnapshot, allSnapshot] = await Promise.all([
                    getDocs(qUser),
                    getDocs(qAll)
                ]);
                
                let totalUnread = userSnapshot.size;
                
                // 3. Compter les notifications globales non lues par CET utilisateur
                allSnapshot.forEach(doc => {
                    const data = doc.data();
                    // V√©rifier si l'utilisateur a lu cette notification globale
                    const hasRead = data.readBy && data.readBy.includes(userId);
                    if (!hasRead) {
                        totalUnread++;
                    }
                });
                
                console.log("üîî Notifications non lues calcul√©es dans profil:", totalUnread);
                return totalUnread;
                
            } catch (error) {
                console.error('‚ùå Erreur lors du comptage des notifications non lues:', error);
                return 0;
            }
        };

        // FONCTION AM√âLIOR√âE : Mettre √† jour le badge de notifications
        window.updateNotificationBadge = async function(userId) {
            try {
                const count = await window.countUnreadNotifications(userId);
                console.log("üîÑ Mise √† jour du badge dans profil:", count);
                
                const badge = document.getElementById('notificationBadge');
                const notificationIcon = document.getElementById('notificationIcon');
                
                if (badge && notificationIcon) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.style.display = 'flex';
                        
                        // Ajouter l'animation si plus de 0 notifications non lues
                        notificationIcon.classList.add('has-unread');
                        
                        // Animation de pulsation
                        if (count > 0) {
                            startNotificationPulse();
                        }
                        
                        console.log("üü° Badge mis √† jour avec", count, "notifications");
                    } else {
                        badge.style.display = 'none';
                        notificationIcon.classList.remove('has-unread');
                        stopNotificationPulse();
                        console.log("‚ö™ Badge cach√© (0 notifications)");
                    }
                }
                
                return count;
            } catch (error) {
                console.error('‚ùå Erreur lors de la mise √† jour du badge:', error);
                return 0;
            }
        };

        // Variables pour g√©rer l'animation
        let pulseInterval = null;

        // Fonction pour d√©marrer l'animation de pulsation
        function startNotificationPulse() {
            // Arr√™ter l'animation existante
            stopNotificationPulse();
            
            const notificationIcon = document.getElementById('notificationIcon');
            if (!notificationIcon) return;
            
            // D√©marrer l'animation
            pulseInterval = setInterval(() => {
                notificationIcon.classList.add('pulse');
                setTimeout(() => {
                    notificationIcon.classList.remove('pulse');
                }, 600);
            }, 5000); // Pulsation toutes les 5 secondes
        }

        // Fonction pour arr√™ter l'animation
        window.stopNotificationPulse = function() {
            if (pulseInterval) {
                clearInterval(pulseInterval);
                pulseInterval = null;
            }
            
            const notificationIcon = document.getElementById('notificationIcon');
            if (notificationIcon) {
                notificationIcon.classList.remove('pulse');
            }
        };

        // FONCTION AM√âLIOR√âE : √âcouter les nouvelles notifications en temps r√©el
        function listenForNewNotificationsInProfile(userId) {
            console.log("üëÇ √âcoute des nouvelles notifications dans le profil pour:", userId);
            
            try {
                const notificationsRef = collection(db, 'notifications');
                
                // √âcouter les notifications pertinentes pour cet utilisateur
                const q = query(
                    notificationsRef,
                    where('target', 'in', [userId, 'all'])
                );
                
                // √âcouter les changements en temps r√©el
                onSnapshot(q, (snapshot) => {
                    const changes = snapshot.docChanges();
                    
                    if (changes.length > 0) {
                        console.log("üì° Changements de notifications d√©tect√©s dans profil");
                        
                        // Mettre √† jour le badge √† chaque changement
                        setTimeout(async () => {
                            if (window.auth.currentUser) {
                                const count = await window.updateNotificationBadge(userId);
                                console.log("‚úÖ Badge mis √† jour apr√®s changement:", count);
                                
                                // Si une nouvelle notification arrive, red√©marrer l'animation
                                const hasNewNotification = changes.some(change => change.type === 'added');
                                if (hasNewNotification && count > 0) {
                                    startNotificationPulse();
                                }
                            }
                        }, 500);
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'√©coute des notifications:', error);
            }
        }

        // Fonction pour forcer la synchronisation du badge
        window.forceSyncNotificationBadge = async function() {
            try {
                const user = auth.currentUser;
                if (user) {
                    console.log("üîÑ Forcer la synchronisation du badge");
                    const count = await window.updateNotificationBadge(user.uid);
                    console.log("‚úÖ Badge synchronis√©:", count);
                    return count;
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la synchronisation forc√©e:', error);
                return 0;
            }
        };

        // Fonction pour synchroniser les donn√©es au retour de la page notification
        window.syncNotificationsOnReturn = async function() {
            const user = auth.currentUser;
            if (user) {
                console.log("üîÑ Synchronisation des notifications au retour");
                // Forcer la mise √† jour du badge
                await window.forceSyncNotificationBadge();
                
                // Rafra√Æchir aussi les stats
                setTimeout(() => {
                    window.refreshUserStatsSilent();
                }, 500);
            }
        };
        
        // Fonction pour obtenir le nom lisible des m√©thodes de retrait
        function getMethodName(methodCode) {
            const methods = {
                'orange_money': 'Orange Money',
                'mtn_money': 'MTN Money',
                'wave': 'Wave',
                'moov_money': 'Moov Money'
            };
            return methods[methodCode] || methodCode;
        }
        
        // V√©rifier l'√©tat d'authentification et rediriger si non connect√©
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // V√©rifier si l'email est v√©rifi√©
                if (!user.emailVerified) {
                    // Rediriger vers la page de connexion si email non v√©rifi√©
                    showNotification('Email non v√©rifi√©', 'Veuillez v√©rifier votre email avant d\'acc√©der √† votre profil.', 'warning', 3000);
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 3000);
                    return;
                }
                
                // D√©marrer l'√©coute des changements de statut des retraits
                window.withdrawalListener = window.listenToWithdrawalStatus(user.uid);
                
                // Initialiser le badge de notifications (attendre un peu pour √™tre s√ªr)
                setTimeout(async () => {
                    await window.updateNotificationBadge(user.uid);
                    console.log("‚úÖ Badge initialis√© pour l'utilisateur:", user.uid);
                }, 1000);
                
                // D√©marrer l'√©coute des nouvelles notifications
                setTimeout(() => {
                    listenForNewNotificationsInProfile(user.uid);
                }, 1500);
                
                // R√©cup√©rer les donn√©es utilisateur depuis Firestore
                const userData = await window.getUserData(user.uid);
                
                if (userData) {
                    // R√©cup√©rer les stats de l'utilisateur (CORRIG√â avec userId)
                    const userStats = await window.getUserStats(user.uid, userData);
                    
                    // Mettre √† jour l'interface avec les donn√©es utilisateur et les stats
                    updateProfileUI(user, userData, userStats);
                } else {
                    showNotification('Erreur', 'Impossible de charger vos donn√©es de profil.', 'error', 4000);
                }
            } else {
                // Arr√™ter l'√©coute si d√©connect√©
                if (window.withdrawalListener) {
                    window.withdrawalListener(); // D√©sabonner l'√©couteur
                    window.withdrawalListener = null;
                }
                
                // Rediriger vers la page de connexion si non connect√©
                window.location.href = 'login.html';
            }
        });
        
        // Fonction pour mettre √† jour l'interface avec les donn√©es utilisateur
        function updateProfileUI(user, userData, userStats) {
            // Mettre √† jour le nom d'utilisateur
            const profileName = document.querySelector('.profile-name');
            if (profileName && userData.username) {
                profileName.textContent = userData.username;
            }
            
            // Mettre √† jour le code de parrainage (NE PAS CHANGER L'ID)
            const referralCodeElement = document.getElementById('referralCode');
            if (referralCodeElement && userData.referralCode) {
                referralCodeElement.textContent = userData.referralCode;
            }
            
            // Mettre √† jour la date d'inscription
            const profileDetails = document.querySelector('.profile-details');
            if (profileDetails && userData.monthYear) {
                // Convertir le format "MM-YYYY" en texte lisible
                const [month, year] = userData.monthYear.split('-');
                const monthNames = [
                    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
                ];
                const monthName = monthNames[parseInt(month) - 1] || month;
                profileDetails.textContent = `Membre depuis ${monthName} ${year}`;
            }
            
            // Mettre √† jour l'email dans l'avatar si souhait√©
            const avatarIcon = document.querySelector('.profile-avatar i');
            if (avatarIcon && user.email) {
                // Utiliser la premi√®re lettre du nom d'utilisateur ou de l'email
                const displayName = userData.username || user.email.split('@')[0];
                avatarIcon.textContent = displayName.charAt(0).toUpperCase();
            }
            
            // Mettre √† jour l'email dans une info-bulle ou autre √©l√©ment si n√©cessaire
            const emailElement = document.getElementById('userEmail');
            if (emailElement) {
                emailElement.textContent = user.email;
            }
            
            // Mettre √† jour les stats
            updateUserStats(userStats);
        }
        
        // Fonction pour mettre √† jour les statistiques
        function updateUserStats(stats) {
            // Mettre √† jour le nombre de filleuls
            const referralsCountElement = document.getElementById('referralsCount');
            if (referralsCountElement) {
                referralsCountElement.textContent = stats.referralsCount;
            }
            
            // Mettre √† jour les gains totaux (en Francs CFA)
            const totalEarningsElement = document.getElementById('totalEarnings');
            if (totalEarningsElement) {
                totalEarningsElement.textContent = `${Math.round(stats.totalEarnings)}Fr`;
            }
            
            // Mettre √† jour les gains disponibles (en Francs CFA)
            const availableEarningsElement = document.getElementById('availableEarnings');
            if (availableEarningsElement) {
                availableEarningsElement.textContent = `${Math.round(stats.availableEarnings)}Fr`;
            }
            
            // Mettre √† jour le solde dans la modale de retrait
            const balanceAmountElement = document.getElementById('balanceAmount');
            if (balanceAmountElement) {
                balanceAmountElement.textContent = `${Math.round(stats.availableEarnings)}Fr`;
            }
            
            // Mettre √† jour le montant maximum de retrait (limit√© √† 300.000Fr)
            updateMaxWithdrawal(stats.availableEarnings);
        }
        
        // Fonction pour mettre √† jour le montant maximum de retrait
        function updateMaxWithdrawal(amount) {
            const withdrawalAmountElement = document.getElementById('withdrawalAmount');
            const maxWithdrawalElement = document.getElementById('maxWithdrawal');
            
            if (withdrawalAmountElement && maxWithdrawalElement) {
                // Limite √† 300.000Fr maximum
                const maxAmount = Math.min(amount, 300000);
                withdrawalAmountElement.max = maxAmount;
                maxWithdrawalElement.textContent = Math.round(maxAmount);
                
                // Mettre √† jour le placeholder
                withdrawalAmountElement.placeholder = `Min: 1000Fr, Max: ${Math.round(maxAmount)}Fr`;
            }
        }
        
        // Fonction pour rafra√Æchir les stats avec notification
        window.refreshUserStats = async function() {
            try {
                const user = auth.currentUser;
                if (!user) return;
                
                const userData = await window.getUserData(user.uid);
                if (userData) {
                    const userStats = await window.getUserStats(user.uid, userData);
                    updateUserStats(userStats);
                    
                    showNotification(
                        'Stats mises √† jour',
                        `Vous avez ${userStats.referralsCount} filleul(s) et ${Math.round(userStats.availableEarnings)}Fr disponibles`,
                        'success',
                        3000
                    );
                }
            } catch (error) {
                console.error('Erreur lors du rafra√Æchissement des stats:', error);
            }
        };
        
        // Rafra√Æchir automatiquement toutes les 20 secondes (plus souvent)
        setInterval(() => {
            if (auth.currentUser) {
                window.refreshUserStatsSilent();
                window.updateNotificationBadge(auth.currentUser.uid);
            }
        }, 20000);
        
        // Fonction pour traiter un retrait (COMPL√àTEMENT CORRIG√âE)
        window.processWithdrawal = async function(userId, amount, method, phoneNumber) {
            try {
                // Calculer les frais selon les paliers
                const fee = window.calculateWithdrawalFee(amount);
                const totalAmount = amount + fee; // Montant total √† d√©biter
                const netAmount = amount; // Montant que l'utilisateur recevra
                
                // R√©cup√©rer les donn√©es utilisateur
                const userDocRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    throw new Error('Utilisateur non trouv√©');
                }
                
                const userData = userDoc.data();
                
                // NOUVELLE LOGIQUE : Calculer le solde disponible r√©el
                // 1. R√©cup√©rer le total des commissions
                const earnings = await window.getUserEarnings(userData.referralCode);
                const totalCommissions = earnings.totalEarnings;
                
                // 2. R√©cup√©rer le total des retraits d√©j√† effectu√©s (avec frais) - excluant les rejet√©s
                const totalWithdrawn = await window.getTotalWithdrawals(userId);
                
                // 3. Calculer le solde disponible r√©el
                const availableEarnings = totalCommissions - totalWithdrawn;
                
                // V√©rifier si le solde disponible est suffisant
                if (availableEarnings < totalAmount) {
                    throw new Error(`Solde insuffisant. Vous avez ${Math.round(availableEarnings)}Fr, besoin de ${totalAmount}Fr (${amount}Fr + ${fee}F de frais)`);
                }
                
                // Cr√©er une demande de retrait avec la structure sp√©cifi√©e
                const withdrawalRef = collection(db, 'withdrawals');
                await addDoc(withdrawalRef, {
                    userId: userId,
                    userEmail: auth.currentUser.email,
                    fee: fee,
                    method: method,
                    netAmount: netAmount,
                    phoneNumber: phoneNumber,
                    processedDate: null,
                    requestDate: new Date().toISOString(),
                    status: 'pending',
                    totalAmount: totalAmount,
                    balanceRestored: false,
                    notified: false
                });
                
                // Mettre √† jour le solde de l'utilisateur (d√©duire le montant total)
                await updateDoc(userDocRef, {
                    availableEarnings: increment(-totalAmount)
                });
                
                return { 
                    success: true, 
                    netAmount: netAmount, 
                    fee: fee, 
                    totalAmount: totalAmount,
                    newAvailableEarnings: availableEarnings - totalAmount
                };
            } catch (error) {
                console.error('Erreur lors du traitement du retrait:', error);
                throw error;
            }
        };

        // √âcouter les messages de mise √† jour de notifications
        window.addEventListener('storage', function(event) {
            if (event.key === 'notificationsUpdated') {
                console.log("üì® Message re√ßu: notifications mises √† jour");
                if (auth.currentUser) {
                    window.forceSyncNotificationBadge();
                }
            }
        });

        // Ex√©cuter la synchronisation quand la page devient visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // La page est redevenue visible
                window.syncNotificationsOnReturn();
            }
        });

        // Synchroniser aussi quand la page est focus
        window.addEventListener('focus', function() {
            window.syncNotificationsOnReturn();
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8A2BE2;
            --primary-dark: #6A1BB2;
            --secondary: #FF6B6B;
            --accent: #00D4FF;
            --dark: #1A1A2E;
            --light: #F8F9FA;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #333333;
            --text-light: #6C757D;
            --success: #28A745;
            --warning: #FFC107;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1A1A2E 0%, #16213E 50%, #0F3460 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 0 80px;
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 15px 10px;
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo-text {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--light);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Styles pour le badge de notifications */
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(255, 107, 107, 0.3);
        }

        /* Animation de pulsation pour les notifications non lues */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }

        /* Classe pour l'animation de pulsation */
        #notificationIcon.pulse {
            animation: pulse 0.6s ease-in-out;
        }

        /* Style pour l'ic√¥ne de notification quand il y a des messages non lus */
        #notificationIcon.has-unread i {
            color: var(--accent);
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* Effet au survol de l'ic√¥ne de notification */
        #notificationIcon:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        #notificationIcon:hover i {
            transform: rotate(-15deg);
            transition: transform 0.3s ease;
        }

        /* Profile Header */
        .profile-header {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            gap: 15px;
        }

        .profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
            flex-shrink: 0;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-status {
            display: inline-block;
            background: var(--accent);
            color: var(--dark);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .profile-details {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Email display */
        .email-display {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .email-display i {
            font-size: 10px;
        }

        /* Stats Grid - Version compacte */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 0 15px 15px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 12px 8px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 3px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-light);
        }

        /* Referral Section */
        .referral-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius);
            padding: 18px;
            color: white;
            margin: 0 15px 15px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.3);
            position: relative;
            overflow: hidden;
            background-image: url('https://images.unsplash.com/photo-1519832979-6fa011b87667?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60');
            background-size: cover;
            background-position: center;
            background-blend-mode: overlay;
        }

        .referral-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(138, 43, 226, 0.8);
            z-index: 1;
        }

        .referral-content {
            position: relative;
            z-index: 2;
        }

        .referral-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .referral-code {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 2px;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: var(--radius);
            margin: 12px 0;
            display: inline-block;
            min-width: 180px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .referral-explanation {
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.4;
            text-align: left;
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: var(--radius);
            backdrop-filter: blur(10px);
        }

        .referral-explanation p {
            margin-bottom: 10px;
        }

        .referral-explanation ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .referral-explanation li {
            margin-bottom: 8px;
            position: relative;
        }

        .referral-explanation strong {
            color: var(--accent);
        }

        .referral-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .referral-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 13px;
        }

        .referral-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .referral-btn.withdraw {
            background: linear-gradient(135deg, var(--success), #20c997);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
            border: none;
        }

        .referral-btn.withdraw:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 18px rgba(40, 167, 69, 0.5);
        }

        /* Options Grid - Version compacte */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 0 15px 15px;
        }

        .option-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px 10px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .option-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .option-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(138, 43, 226, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--primary);
            margin: 0 auto 8px;
        }

        .option-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 3px;
            font-size: 13px;
        }

        .option-desc {
            font-size: 11px;
            color: var(--text-light);
        }

        /* Logout Button */
        .logout-section {
            margin: 20px 15px;
            text-align: center;
        }

        .logout-btn {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #FF6B6B;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: rgba(255, 107, 107, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
        }

        /* Share Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .share-modal {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: var(--transition);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.active .share-modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2C3E50;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.4rem;
            color: #7F8C8D;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: #2C3E50;
        }

        .modal-body {
            margin-bottom: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: var(--radius);
            background: rgba(0, 0, 0, 0.03);
            cursor: pointer;
            transition: var(--transition);
        }

        .share-option:hover {
            background: rgba(138, 43, 226, 0.1);
            transform: translateY(-3px);
        }

        .share-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .share-icon.whatsapp {
            background: #25D366;
        }

        .share-icon.telegram {
            background: #0088cc;
        }

        .share-icon.messenger {
            background: #006AFF;
        }

        .share-icon.email {
            background: #EA4335;
        }

        .share-icon.sms {
            background: #34B7F1;
        }

        .share-icon.copy {
            background: var(--primary);
        }

        .share-label {
            font-size: 11px;
            font-weight: 600;
            color: #2C3E50;
            text-align: center;
        }

        /* Withdrawal Modal - Style int√©gr√© avec scroll */
        .withdrawal-modal {
            background: #FFFFFF;
            border-radius: var(--radius);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: var(--transition);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.active .withdrawal-modal {
            transform: translateY(0);
        }

        .balance-display {
            text-align: center;
            margin-bottom: 15px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
            border-radius: var(--radius);
            border: 1px solid rgba(40, 167, 69, 0.2);
            flex-shrink: 0;
        }

        .balance-label {
            font-size: 13px;
            color: #2C3E50;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .balance-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--success);
        }

        .withdrawal-info {
            background: linear-gradient(135deg, rgba(41, 128, 185, 0.1), rgba(52, 152, 219, 0.1));
            border-left: 4px solid #2980B9;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .withdrawal-info p {
            margin: 0;
            font-size: 13px;
            color: #2C3E50;
            line-height: 1.5;
        }

        .withdrawal-info i {
            color: #2980B9;
            margin-right: 8px;
        }

        .form-group {
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2C3E50;
            font-size: 14px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background-color: #FFFFFF;
            color: #2C3E50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
        }

        .form-help {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #7F8C8D;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-shrink: 0;
        }

        .btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), #5a189a);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(138, 43, 226, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95A5A6, #7F8C8D);
            color: white;
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #7F8C8D, #6C7A7D);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(149, 165, 166, 0.4);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
            font-size: 11px;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--accent);
        }

        .nav-icon {
            font-size: 18px;
        }

        /* Syst√®me de notifications √©l√©gant */
        .notification-system {
            position: fixed;
            top: 80px;
            right: 15px;
            z-index: 2000;
            max-width: 320px;
        }

        .notification {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.error {
            border-left-color: var(--secondary);
        }

        .notification.info {
            border-left-color: var(--accent);
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .notification.success .notification-icon {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }

        .notification.warning .notification-icon {
            background: rgba(255, 193, 7, 0.15);
            color: var(--warning);
        }

        .notification.error .notification-icon {
            background: rgba(255, 107, 107, 0.15);
            color: var(--secondary);
        }

        .notification.info .notification-icon {
            background: rgba(0, 212, 255, 0.15);
            color: var(--accent);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-message {
            color: var(--text-light);
            font-size: 13px;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text);
        }

        /* Modal de confirmation personnalis√©e */
        .confirmation-modal {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: var(--transition);
            text-align: center;
        }

        .modal-overlay.active .confirmation-modal {
            transform: scale(1);
        }

        .confirmation-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--secondary);
            margin: 0 auto 15px;
        }

        .confirmation-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
        }

        .confirmation-message {
            color: var(--text-light);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirmation-actions {
            display: flex;
            gap: 10px;
        }

        .confirm-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .confirm-btn.danger {
            background: var(--secondary);
            color: white;
        }

        .confirm-btn.danger:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .confirm-btn.cancel {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text);
        }

        .confirm-btn.cancel:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-light);
            gap: 15px;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Support pour les modes sombre/clair du syst√®me */
        @media (prefers-color-scheme: dark) {
            .stat-card, .option-card {
                background: rgba(30, 30, 46, 0.95);
            }
            
            .stat-value, .option-title {
                color: var(--light);
            }
            
            .stat-label, .option-desc {
                color: var(--text-light);
            }
            
            .share-modal, .withdrawal-modal, .confirmation-modal {
                background: rgba(30, 30, 46, 0.95);
            }
            
            .modal-title, .share-label {
                color: var(--light);
            }
            
            .form-select, .form-input {
                background-color: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
                color: var(--light);
            }
            
            .form-select:focus, .form-input:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.3);
            }
            
            .balance-display {
                background: linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(32, 201, 151, 0.2));
                border-color: rgba(40, 167, 69, 0.3);
            }
            
            .balance-label {
                color: var(--light);
            }
            
            .withdrawal-info {
                background: linear-gradient(135deg, rgba(41, 128, 185, 0.2), rgba(52, 152, 219, 0.2));
                border-left-color: var(--accent);
            }
            
            .withdrawal-info p {
                color: var(--light);
            }
            
            .withdrawal-info i {
                color: var(--accent);
            }
            
            .form-label {
                color: var(--light);
            }
            
            .form-help {
                color: rgba(255, 255, 255, 0.6);
            }
        }

        /* Responsive - Corrections */
        @media (max-width: 480px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .referral-actions {
                flex-direction: column;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .share-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .referral-explanation {
                font-size: 13px;
                padding: 12px;
            }
            
            .notification-system {
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            /* Modales avec scroll */
            .share-modal, .withdrawal-modal {
                max-height: 85vh;
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 750px;
            }
            
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Correction pour les tr√®s petits √©crans (iPhone SE) */
        @media (max-width: 375px) {
            .app-container {
                padding: 0 8px 80px;
            }
            
            .app-header {
                padding: 12px 8px 8px;
            }
            
            .logo-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            
            .logo-text {
                font-size: 1.2rem;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .badge {
                width: 16px;
                height: 16px;
                font-size: 9px;
                top: -4px;
                right: -4px;
            }
            
            .profile-header {
                padding: 15px 8px;
            }
            
            .profile-avatar {
                width: 65px;
                height: 65px;
                font-size: 22px;
            }
            
            .profile-name {
                font-size: 1.2rem;
            }
            
            .profile-details {
                font-size: 12px;
            }
            
            .stats-grid {
                margin: 0 8px 12px;
                gap: 6px;
            }
            
            .stat-card {
                padding: 10px 6px;
                border-radius: 10px;
            }
            
            .stat-value {
                font-size: 1rem;
            }
            
            .stat-label {
                font-size: 10px;
            }
            
            .referral-card {
                margin: 0 8px 12px;
                padding: 15px;
                border-radius: 10px;
            }
            
            .referral-title {
                font-size: 1.1rem;
            }
            
            .referral-code {
                font-size: 1.2rem;
                min-width: 160px;
                padding: 10px;
                letter-spacing: 1px;
            }
            
            .referral-explanation {
                font-size: 12px;
                padding: 10px;
            }
            
            .referral-explanation ul {
                padding-left: 15px;
            }
            
            .referral-explanation li {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .referral-actions {
                gap: 6px;
                margin-top: 12px;
            }
            
            .referral-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .options-grid {
                margin: 0 8px 12px;
                gap: 8px;
            }
            
            .option-card {
                padding: 12px 8px;
                border-radius: 10px;
            }
            
            .option-icon {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
            
            .option-title {
                font-size: 12px;
            }
            
            .option-desc {
                font-size: 10px;
            }
            
            .logout-section {
                margin: 15px 8px;
            }
            
            .logout-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            /* Modales */
            .share-modal, .withdrawal-modal {
                width: 95%;
                padding: 15px;
                max-height: 85vh;
            }
            
            .share-options {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .share-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .share-label {
                font-size: 10px;
            }
            
            .balance-amount {
                font-size: 1.5rem;
            }
            
            .form-input, .form-select {
                padding: 9px 10px;
                font-size: 13px;
            }
            
            .btn {
                padding: 9px 12px;
                font-size: 13px;
            }
            
            /* Notification */
            .notification-system {
                top: 70px;
                right: 8px;
                left: 8px;
            }
            
            .notification {
                padding: 12px;
            }
            
            .notification-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .notification-title {
                font-size: 13px;
            }
            
            .notification-message {
                font-size: 12px;
            }
            
            .bottom-nav {
                padding: 10px 0 8px;
            }
            
            .nav-item {
                font-size: 9px;
                gap: 3px;
            }
            
            .nav-icon {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Syst√®me de notifications -->
    <div class="notification-system" id="notificationSystem"></div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-dice"></i>
                </div>
                <div class="logo-text">GameHub</div>
            </div>
            <div class="user-actions">
                <div class="icon-btn" id="refreshStatsBtn" title="Rafra√Æchir les stats">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="icon-btn" id="notificationIcon" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <!-- Badge pour le compteur de notifications non lues -->
                    <div class="badge" id="notificationBadge" style="display: none;">0</div>
                </div>
                <div class="icon-btn">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
        </header>

        <!-- Profile Header -->
        <section class="profile-header">
            <div class="profile-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="profile-info">
                <h1 class="profile-name" id="profileName">Chargement...</h1>
                <div class="profile-status">Membre Premium</div>
                <p class="profile-details" id="profileDetails">Chargement...</p>
                <div class="email-display" id="userEmail">
                    <i class="fas fa-envelope"></i> <span id="emailText">Chargement...</span>
                </div>
            </div>
        </section>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="referralsCount">0</div>
                <div class="stat-label">Filleuls</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEarnings">0Fr</div>
                <div class="stat-label">Gains totaux</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="availableEarnings">0Fr</div>
                <div class="stat-label">Disponible</div>
            </div>
        </div>

        <!-- Referral Section -->
        <section class="referral-card">
            <div class="referral-content">
                <h2 class="referral-title">Devenez Parrain & Gagnez 30%</h2>
                <div class="referral-code" id="referralCode">Chargement...</div>
                
                <div class="referral-explanation">
                    <p><strong>üéØ Programme de Parrainage GameHub</strong></p>
                    <p><strong>Comment √ßa marche ?</strong></p>
                    <ul>
                        <li>Partagez votre code avec vos amis</li>
                        <li>Ils l'utilisent pour s'inscrire sur GameHub</li>
                        <li>Vous gagnez <strong>30% de commission</strong> sur chaque bot qu'ils ach√®tent</li>
                        <li>Vos gains sont disponibles imm√©diatement</li>
                    </ul>
                    <p><strong>üí∞ Exemple :</strong> Votre filleul ach√®te un bot √† 10.000Fr ‚Üí Vous gagnez 3.000Fr</p>
                    <p style="text-align: center; margin-top: 10px; font-weight: 600;">
                        Plus vous parrainez, plus vous gagnez !
                    </p>
                </div>
                
                <div class="referral-actions">
                    <button class="referral-btn" id="copyCode">
                        <i class="fas fa-copy"></i> Copier le code
                    </button>
                    <button class="referral-btn" id="shareCode">
                        <i class="fas fa-share-alt"></i> Partager
                    </button>
                    <button class="referral-btn withdraw" id="withdrawEarnings">
                        <i class="fas fa-money-bill-wave"></i> Retirer mes gains
                    </button>
                </div>
            </div>
        </section>

        <!-- Options Grid -->
        <div class="options-grid">
            <div class="option-card" onclick="showNotification('Profil', 'Cette fonctionnalit√© sera bient√¥t disponible !', 'info', 3000)">
                <div class="option-icon">
                    <i class="fas fa-user-edit"></i>
                </div>
                <div class="option-title">Profil</div>
                <div class="option-desc">Modifier mes informations</div>
            </div>
            
            <div class="option-card" onclick="window.location.href='historique.html'">
                <div class="option-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="option-title">Historique</div>
                <div class="option-desc">Voir mes gains</div>
            </div>
            
            <div class="option-card" onclick="window.location.href='aide.html'">
                <div class="option-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="option-title">Aide</div>
                <div class="option-desc">FAQ & Support</div>
            </div>
            
            <div class="option-card" onclick="window.location.href='√†-propos.html'">
                <div class="option-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="option-title">√Ä propos</div>
                <div class="option-desc">GameHub v2.1.0</div>
            </div>
        </div>

        <!-- Logout Section -->
        <div class="logout-section">
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Se d√©connecter
            </button>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="share-modal">
            <div class="modal-header">
                <h3 class="modal-title">Partager mon code</h3>
                <button class="close-modal" id="closeShareModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #2C3E50; margin-bottom: 20px; text-align: center;">Choisissez comment partager votre code de parrainage</p>
                
                <div class="share-options">
                    <div class="share-option" data-method="whatsapp">
                        <div class="share-icon whatsapp">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="share-label">WhatsApp</div>
                    </div>
                    
                    <div class="share-option" data-method="telegram">
                        <div class="share-icon telegram">
                            <i class="fab fa-telegram"></i>
                        </div>
                        <div class="share-label">Telegram</div>
                    </div>
                    
                    <div class="share-option" data-method="messenger">
                        <div class="share-icon messenger">
                            <i class="fab fa-facebook-messenger"></i>
                        </div>
                        <div class="share-label">Messenger</div>
                    </div>
                    
                    <div class="share-option" data-method="email">
                        <div class="share-icon email">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="share-label">E-mail</div>
                    </div>
                    
                    <div class="share-option" data-method="sms">
                        <div class="share-icon sms">
                            <i class="fas fa-sms"></i>
                        </div>
                        <div class="share-label">SMS</div>
                    </div>
                    
                    <div class="share-option" data-method="copy">
                        <div class="share-icon copy">
                            <i class="fas fa-copy"></i>
                        </div>
                        <div class="share-label">Copier</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="modal-overlay" id="withdrawalModal">
        <div class="withdrawal-modal">
            <div class="modal-header">
                <h3 class="modal-title">Retrait des gains</h3>
                <button class="close-modal" id="closeWithdrawalModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="balance-display">
                    <div class="balance-label">Solde disponible</div>
                    <div class="balance-amount" id="balanceAmount">0Fr</div>
                </div>
                
                <div class="withdrawal-info">
                    <p><i class="fas fa-info-circle"></i> 
                        Le retrait est trait√© sous 24-48h. 
                        Un minimum de 1.000Fr est requis. 
                        Maximum autoris√© : 300.000Fr.
                        <br>
                        <strong>Des frais variables s'appliquent selon le montant du retrait.</strong>
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="withdrawalMethod">M√©thode de retrait</label>
                    <select class="form-select" id="withdrawalMethod">
                        <option value="">S√©lectionnez une m√©thode</option>
                        <option value="orange_money">Orange Money</option>
                        <option value="mtn_money">MTN Money</option>
                        <option value="wave">Wave</option>
                        <option value="moov_money">Moov Money</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="withdrawalAmount">Montant √† retirer (Francs CFA)</label>
                    <input type="number" class="form-input" id="withdrawalAmount" min="1000" max="300000" placeholder="Ex: 5000" value="">
                    <small class="form-help">Minimum: 1.000Fr, Maximum: 300.000Fr</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="accountDetails">Num√©ro Mobile Money</label>
                    <input type="tel" class="form-input" id="accountDetails" placeholder="Ex: 07XXXXXX ou 05XXXXXX" pattern="[0-9]{8,12}" inputmode="numeric">
                    <small class="form-help">Entrez uniquement votre num√©ro Mobile Money (ex: 07XXXXXX)</small>
                </div>
                
                <!-- Affichage des calculs de frais -->
                <div class="withdrawal-calculations" id="withdrawalCalculations" style="display: none; background: rgba(0,0,0,0.03); padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <p style="margin: 0; font-size: 13px; color: #2C3E50;">
                        <strong>D√©tails du retrait :</strong><br>
                        Montant demand√© : <span id="requestedAmount">0</span>Fr<br>
                        Frais de retrait : <span id="feeAmount">0</span>Fr<br>
                        Total d√©bit√© : <span id="totalDebited">0</span>Fr<br>
                        Vous recevrez : <span id="netAmountDisplay">0</span>Fr
                    </p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelWithdrawal">Annuler</button>
                <button class="btn btn-primary" id="confirmWithdrawal">Confirmer le retrait</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de d√©connexion -->
    <div class="modal-overlay" id="logoutModal">
        <div class="confirmation-modal">
            <div class="confirmation-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <h3 class="confirmation-title">D√©connexion</h3>
            <p class="confirmation-message">√ätes-vous s√ªr de vouloir vous d√©connecter de votre compte GameHub ?</p>
            <div class="confirmation-actions">
                <button class="confirm-btn cancel" id="cancelLogout">Annuler</button>
                <button class="confirm-btn danger" id="confirmLogout">Se d√©connecter</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item" onclick="window.location.href='accueil.html'">
            <i class="fas fa-home nav-icon"></i>
            <span>Accueil</span>
        </div>
        <div class="nav-item" onclick="window.location.href='jeux.html'">
            <i class="fas fa-gamepad nav-icon"></i>
            <span>Mes Jeux</span>
        </div>
        <div class="nav-item" onclick="window.location.href='promotions.html'">
            <i class="fas fa-gift nav-icon"></i>
            <span>Promos</span>
        </div>
        <div class="nav-item active">
            <i class="fas fa-user nav-icon"></i>
            <span>Profil</span>
        </div>
    </nav>

    <script>
        // Fonction pour afficher des notifications √©l√©gantes
        function showNotification(title, message, type = 'info', duration = 4000) {
            const notificationSystem = document.getElementById('notificationSystem');
            const notificationId = 'notification-' + Date.now();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.id = notificationId;
            
            const icons = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification('${notificationId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notificationSystem.appendChild(notification);
            
            // Animation d'entr√©e
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Fermeture automatique
            if (duration > 0) {
                setTimeout(() => {
                    closeNotification(notificationId);
                }, duration);
            }
            
            return notificationId;
        }

        // Fonction pour fermer une notification
        function closeNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.classList.remove('show');
                notification.classList.add('hide');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }
        }

        // V√©rifier si des notifications ont √©t√© mises √† jour depuis la derni√®re visite
        function setupNotificationSync() {
            // V√©rifier toutes les 5 secondes si des notifications ont √©t√© mises √† jour
            setInterval(() => {
                const lastUpdate = window.localStorage.getItem('notificationsUpdated');
                const lastProfileVisit = window.localStorage.getItem('lastProfileVisit');
                
                if (lastUpdate && lastProfileVisit && parseInt(lastUpdate) > parseInt(lastProfileVisit)) {
                    console.log("üîÑ Notifications mises √† jour d√©tect√©es");
                    if (window.auth && window.auth.currentUser) {
                        window.forceSyncNotificationBadge();
                        // Mettre √† jour le timestamp de visite
                        window.localStorage.setItem('lastProfileVisit', Date.now().toString());
                    }
                }
            }, 5000);
            
            // Forcer la mise √† jour initiale
            setTimeout(() => {
                if (window.auth && window.auth.currentUser) {
                    window.forceSyncNotificationBadge();
                }
            }, 3000);
        }

        // Animation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Animation des sections
            const sections = document.querySelectorAll('.stats-grid, .referral-card, .options-grid, .logout-section');
            sections.forEach((section, index) => {
                section.style.animation = `fadeInUp 0.5s ease forwards ${index * 0.1}s`;
                section.style.opacity = '0';
            });

            // Interaction avec la navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    navItems.forEach(n => n.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Interaction avec les options
            const optionCards = document.querySelectorAll('.option-card');
            optionCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Ajout d'un effet visuel au clic
                    this.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 200);
                });
            });

            // Interaction avec le code de parrainage - CORRIG√â
            const copyCodeBtn = document.getElementById('copyCode');
            copyCodeBtn.addEventListener('click', function() {
                const referralCodeElement = document.getElementById('referralCode');
                if (!referralCodeElement) {
                    showNotification(
                        'Erreur',
                        '√âl√©ment de code de parrainage introuvable',
                        'error',
                        3000
                    );
                    return;
                }
                
                const referralCode = referralCodeElement.textContent;
                if (referralCode === 'Chargement...' || !referralCode || referralCode.trim() === '') {
                    showNotification(
                        'Erreur',
                        'Code de parrainage non disponible',
                        'error',
                        3000
                    );
                    return;
                }
                
                navigator.clipboard.writeText(referralCode).then(() => {
                    showNotification(
                        'Code copi√© !',
                        `Le code "${referralCode}" a √©t√© copi√© dans le presse-papiers.`,
                        'success',
                        3000
                    );
                }).catch((err) => {
                    console.error('Erreur de copie:', err);
                    showNotification(
                        'Erreur',
                        'Impossible de copier le code. Veuillez r√©essayer.',
                        'error',
                        4000
                    );
                });
            });

            // Bouton de rafra√Æchissement des stats
            const refreshStatsBtn = document.getElementById('refreshStatsBtn');
            refreshStatsBtn.addEventListener('click', function() {
                refreshStatsBtn.style.animation = 'spin 1s linear';
                setTimeout(() => {
                    refreshStatsBtn.style.animation = '';
                }, 1000);
                
                window.refreshUserStats();
            });

            // Redirection vers les notifications avec synchronisation
            const notificationIcon = document.getElementById('notificationIcon');
            if (notificationIcon) {
                notificationIcon.addEventListener('click', function() {
                    console.log("üîî Ic√¥ne de notification cliqu√©e");
                    
                    // Sauvegarder l'√©tat actuel
                    const currentTime = Date.now().toString();
                    window.localStorage.setItem('lastProfileVisit', currentTime);
                    
                    // Rediriger
                    window.location.href = 'notification.html';
                });
                
                // Effet visuel au survol
                notificationIcon.addEventListener('mouseenter', function() {
                    const badge = document.getElementById('notificationBadge');
                    if (badge && badge.style.display !== 'none') {
                        this.style.transform = 'translateY(-2px) scale(1.1)';
                    }
                });
                
                notificationIcon.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                });
            }

            // CORRECTION : Gestion de la d√©connexion avec Firebase
            const logoutBtn = document.getElementById('logoutBtn');
            const logoutModal = document.getElementById('logoutModal');
            const cancelLogoutBtn = document.getElementById('cancelLogout');
            const confirmLogoutBtn = document.getElementById('confirmLogout');

            // Fonction pour ouvrir la modale de d√©connexion
            function openLogoutModal() {
                if (logoutModal) {
                    logoutModal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }

            // Fonction pour fermer la modale de d√©connexion
            function closeLogoutModal() {
                if (logoutModal) {
                    logoutModal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            }

            // Ouvrir la modale de d√©connexion
            if (logoutBtn) {
                logoutBtn.addEventListener('click', openLogoutModal);
            }

            // Fermer la modale de d√©connexion
            if (cancelLogoutBtn) {
                cancelLogoutBtn.addEventListener('click', closeLogoutModal);
            }

            // CORRECTION : Fonction de d√©connexion simplifi√©e
            async function logoutUser() {
                try {
                    console.log("üö™ Tentative de d√©connexion...");
                    
                    // Arr√™ter l'√©coute des retraits
                    if (window.withdrawalListener) {
                        window.withdrawalListener();
                        window.withdrawalListener = null;
                    }
                    
                    // Arr√™ter l'animation de notifications
                    if (window.stopNotificationPulse) {
                        window.stopNotificationPulse();
                    }
                    
                    // D√©connexion avec Firebase - CORRECTION
                    if (window.firebaseSignOut && window.auth) {
                        await window.firebaseSignOut(window.auth);
                        console.log("‚úÖ D√©connexion r√©ussie");
                        
                        showNotification(
                            'D√©connexion r√©ussie', 
                            'Vous avez √©t√© d√©connect√© avec succ√®s.', 
                            'success', 
                            3000
                        );
                        
                        // Fermer la modale
                        closeLogoutModal();
                        
                        // Redirection vers la page de connexion
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1500);
                    } else {
                        throw new Error('Firebase Auth non disponible');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors de la d√©connexion:', error);
                    showNotification(
                        'Erreur de d√©connexion',
                        error.message || 'Une erreur est survenue lors de la d√©connexion.',
                        'error',
                        4000
                    );
                    closeLogoutModal();
                }
            }

            // Confirmer la d√©connexion
            if (confirmLogoutBtn) {
                confirmLogoutBtn.addEventListener('click', logoutUser);
            }

            // Fermer la modale en cliquant √† l'ext√©rieur
            if (logoutModal) {
                logoutModal.addEventListener('click', function(e) {
                    if (e.target === logoutModal) {
                        closeLogoutModal();
                    }
                });
            }

            // Gestion de la modale de partage - CORRIG√â
            const shareModal = document.getElementById('shareModal');
            const shareCodeBtn = document.getElementById('shareCode');
            const closeShareModalBtn = document.getElementById('closeShareModal');
            const shareOptions = document.querySelectorAll('.share-option');

            // Ouvrir la modale de partage
            if (shareCodeBtn) {
                shareCodeBtn.addEventListener('click', function() {
                    const referralCodeElement = document.getElementById('referralCode');
                    if (!referralCodeElement) {
                        showNotification(
                            'Erreur',
                            '√âl√©ment de code de parrainage introuvable',
                            'error',
                            3000
                        );
                        return;
                    }
                    
                    const referralCode = referralCodeElement.textContent;
                    if (referralCode === 'Chargement...' || !referralCode || referralCode.trim() === '') {
                        showNotification(
                            'Erreur',
                            'Code de parrainage non disponible',
                            'error',
                            3000
                        );
                        return;
                    }
                    
                    if (shareModal) {
                        shareModal.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    }
                });
            }

            // Fermer la modale de partage
            function closeShareModal() {
                if (shareModal) {
                    shareModal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            }

            if (closeShareModalBtn) {
                closeShareModalBtn.addEventListener('click', closeShareModal);
            }

            // Gestion des options de partage - CORRIG√â
            shareOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const method = this.getAttribute('data-method');
                    const referralCodeElement = document.getElementById('referralCode');
                    
                    if (!referralCodeElement) {
                        showNotification(
                            'Erreur',
                            'Code de parrainage introuvable',
                            'error',
                            3000
                        );
                        closeShareModal();
                        return;
                    }
                    
                    const referralCode = referralCodeElement.textContent;
                    if (referralCode === 'Chargement...' || !referralCode || referralCode.trim() === '') {
                        showNotification(
                            'Erreur',
                            'Code de parrainage non disponible',
                            'error',
                            3000
                        );
                        closeShareModal();
                        return;
                    }
                    
                    const message = `Rejoins-moi sur GameHub ! Utilise mon code de parrainage ${referralCode} pour b√©n√©ficier d'avantages exclusifs et je gagnerai 30% de commission sur tes achats de bots !`;
                    const url = 'https://gamehub.com';

                    switch(method) {
                        case 'whatsapp':
                            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                            break;
                        case 'telegram':
                            window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(message)}`, '_blank');
                            break;
                        case 'messenger':
                            window.open(`https://www.facebook.com/dialog/send?link=${encodeURIComponent(url)}&app_id=YOUR_APP_ID&redirect_uri=${encodeURIComponent(url)}`, '_blank');
                            break;
                        case 'email':
                            window.open(`mailto:?subject=Rejoins-moi sur GameHub&body=${encodeURIComponent(message)}`, '_blank');
                            break;
                        case 'sms':
                            window.open(`sms:?body=${encodeURIComponent(message)}`, '_blank');
                            break;
                        case 'copy':
                            navigator.clipboard.writeText(`${message} ${url}`).then(() => {
                                showNotification(
                                    'Lien copi√© !',
                                    'Le lien de parrainage a √©t√© copi√© dans le presse-papiers.',
                                    'success',
                                    3000
                                );
                            }).catch((err) => {
                                console.error('Erreur de copie:', err);
                                showNotification(
                                    'Erreur',
                                    'Impossible de copier le lien. Veuillez r√©essayer.',
                                    'error',
                                    4000
                                );
                            });
                            break;
                    }

                    closeShareModal();
                });
            });

            // Gestion de la modale de retrait
            const withdrawalModal = document.getElementById('withdrawalModal');
            const withdrawEarningsBtn = document.getElementById('withdrawEarnings');
            const closeWithdrawalModalBtn = document.getElementById('closeWithdrawalModal');
            const cancelWithdrawalBtn = document.getElementById('cancelWithdrawal');
            const confirmWithdrawalBtn = document.getElementById('confirmWithdrawal');
            const withdrawalAmountInput = document.getElementById('withdrawalAmount');
            const withdrawalCalculations = document.getElementById('withdrawalCalculations');

            // Mettre √† jour les calculs de frais en temps r√©el
            function updateWithdrawalCalculations() {
                const amount = parseInt(withdrawalAmountInput.value) || 0;
                
                if (amount >= 1000) {
                    // Calculer les frais selon les paliers
                    let fee = 0;
                    
                    if (amount >= 1000 && amount <= 9999) {
                        fee = 250;
                    } else if (amount >= 10000 && amount <= 49999) {
                        fee = 500;
                    } else if (amount >= 50000 && amount <= 99999) {
                        fee = 1000;
                    } else if (amount >= 100000 && amount <= 300000) {
                        fee = 2500;
                    }
                    
                    const total = amount + fee;
                    const net = amount;
                    
                    document.getElementById('requestedAmount').textContent = amount.toLocaleString();
                    document.getElementById('feeAmount').textContent = fee.toLocaleString();
                    document.getElementById('totalDebited').textContent = total.toLocaleString();
                    document.getElementById('netAmountDisplay').textContent = net.toLocaleString();
                    withdrawalCalculations.style.display = 'block';
                } else {
                    withdrawalCalculations.style.display = 'none';
                }
            }

            // Ouvrir la modale de retrait
            if (withdrawEarningsBtn) {
                withdrawEarningsBtn.addEventListener('click', function() {
                    const availableEarningsElement = document.getElementById('availableEarnings');
                    if (!availableEarningsElement) {
                        showNotification(
                            'Erreur',
                            'Impossible de r√©cup√©rer le solde',
                            'error',
                            4000
                        );
                        return;
                    }
                    
                    const availableEarningsText = availableEarningsElement.textContent;
                    const availableEarnings = parseInt(availableEarningsText.replace('Fr', ''));
                    
                    // Calculer le montant minimum requis (1000 + frais minimum de 250)
                    const minRequired = 1250;
                    
                    if (isNaN(availableEarnings) || availableEarnings < minRequired) {
                        showNotification(
                            'Fonds insuffisants',
                            `Vous devez avoir au moins ${minRequired.toLocaleString()}Fr (1.000Fr + frais) pour effectuer un retrait.`,
                            'warning',
                            4000
                        );
                        return;
                    }
                    
                    // R√©initialiser les champs
                    document.getElementById('withdrawalMethod').value = '';
                    withdrawalAmountInput.value = '';
                    document.getElementById('accountDetails').value = '';
                    withdrawalCalculations.style.display = 'none';
                    
                    if (withdrawalModal) {
                        withdrawalModal.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    }
                });
            }

            // Mettre √† jour les calculs quand le montant change
            if (withdrawalAmountInput) {
                withdrawalAmountInput.addEventListener('input', function() {
                    updateWithdrawalCalculations();
                });
            }

            // Fermer la modale de retrait
            function closeWithdrawalModal() {
                if (withdrawalModal) {
                    withdrawalModal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            }

            if (closeWithdrawalModalBtn) {
                closeWithdrawalModalBtn.addEventListener('click', closeWithdrawalModal);
            }
            
            if (cancelWithdrawalBtn) {
                cancelWithdrawalBtn.addEventListener('click', closeWithdrawalModal);
            }

            // Confirmer le retrait (CORRIG√â avec frais variables)
            if (confirmWithdrawalBtn) {
                confirmWithdrawalBtn.addEventListener('click', async function() {
                    const method = document.getElementById('withdrawalMethod').value;
                    const amountInput = document.getElementById('withdrawalAmount');
                    const amount = parseInt(amountInput.value);
                    const accountDetails = document.getElementById('accountDetails').value;
                    
                    // Validation du montant
                    if (isNaN(amount) || amount < 1000) {
                        showNotification(
                            'Montant insuffisant',
                            'Le montant minimum de retrait est de 1.000 Francs CFA.',
                            'error',
                            4000
                        );
                        amountInput.focus();
                        return;
                    }
                    
                    if (amount > 300000) {
                        showNotification(
                            'Montant trop √©lev√©',
                            'Le montant maximum autoris√© est de 300.000 Francs CFA.',
                            'error',
                            4000
                        );
                        amountInput.focus();
                        return;
                    }
                    
                    // Calculer les frais selon les paliers
                    const fee = window.calculateWithdrawalFee(amount);
                    if (fee === 0) {
                        showNotification(
                            'Montant invalide',
                            'Le montant doit √™tre compris entre 1.000 et 300.000 Francs CFA.',
                            'error',
                            4000
                        );
                        return;
                    }
                    
                    const totalAmount = amount + fee;
                    
                    // Validation du num√©ro Mobile Money
                    const phoneRegex = /^[0-9]{8,12}$/;
                    if (!accountDetails || !phoneRegex.test(accountDetails)) {
                        showNotification(
                            'Num√©ro invalide',
                            'Veuillez saisir un num√©ro Mobile Money valide (8 √† 12 chiffres).',
                            'error',
                            4000
                        );
                        document.getElementById('accountDetails').focus();
                        return;
                    }
                    
                    // Validation de la m√©thode
                    if (!method) {
                        showNotification(
                            'M√©thode manquante',
                            'Veuillez s√©lectionner une m√©thode de retrait.',
                            'warning',
                            4000
                        );
                        return;
                    }
                    
                    // V√©rification du solde disponible (incluant les frais)
                    const availableEarningsElement = document.getElementById('availableEarnings');
                    const availableEarningsText = availableEarningsElement.textContent;
                    const currentAvailableEarnings = parseInt(availableEarningsText.replace('Fr', ''));
                    
                    if (totalAmount > currentAvailableEarnings) {
                        showNotification(
                            'Solde insuffisant',
                            `Votre solde disponible est de ${currentAvailableEarnings.toLocaleString()}Fr. 
                            Le montant total (${amount.toLocaleString()}Fr + ${fee.toLocaleString()}Fr de frais = ${totalAmount.toLocaleString()}Fr) d√©passe votre solde.`,
                            'error',
                            4000
                        );
                        return;
                    }
                    
                    try {
                        const user = window.auth.currentUser;
                        if (!user) {
                            showNotification('Erreur', 'Vous devez √™tre connect√©', 'error', 4000);
                            return;
                        }

                        // Traiter le retrait via Firebase (fonction corrig√©e)
                        const result = await window.processWithdrawal(user.uid, amount, method, accountDetails);
                        
                        if (result.success) {
                            // MISE √Ä JOUR IMM√âDIATE DU SOLDE DISPONIBLE
                            const newAvailableEarnings = Math.max(0, Math.round(result.newAvailableEarnings));
                            
                            // Mettre √† jour tous les √©l√©ments du DOM avec le nouveau solde
                            availableEarningsElement.textContent = `${newAvailableEarnings}Fr`;
                            document.getElementById('balanceAmount').textContent = `${newAvailableEarnings}Fr`;
                            
                            // Mettre √† jour le maxWithdrawal
                            updateMaxWithdrawal(newAvailableEarnings);
                            
                            showNotification(
                                'Retrait demand√©',
                                `Votre retrait de ${result.netAmount.toLocaleString()}Fr via ${getMethodName(method)} est en cours de traitement. 
                                Frais: ${result.fee.toLocaleString()}F, Total d√©bit√©: ${result.totalAmount.toLocaleString()}Fr.
                                Il sera cr√©dit√© sur le num√©ro ${accountDetails} sous 24-48h.`,
                                'success',
                                5000
                            );
                            
                            // Fermer la modale
                            closeWithdrawalModal();
                            
                            // R√©initialiser le formulaire
                            document.getElementById('withdrawalMethod').value = '';
                            amountInput.value = '';
                            document.getElementById('accountDetails').value = '';
                            withdrawalCalculations.style.display = 'none';
                            
                            // Rafra√Æchir les stats pour synchroniser (avec le serveur)
                            setTimeout(() => {
                                window.refreshUserStats();
                            }, 1000);
                        }
                        
                    } catch (error) {
                        console.error('Erreur lors du retrait:', error);
                        showNotification(
                            'Erreur',
                            error.message || 'Une erreur est survenue lors du traitement du retrait. Veuillez r√©essayer.',
                            'error',
                            5000
                        );
                    }
                });
            }

            // Fermer les modales en cliquant √† l'ext√©rieur
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        if (modal.id === 'shareModal') {
                            closeShareModal();
                        } else if (modal.id === 'withdrawalModal') {
                            closeWithdrawalModal();
                        } else if (modal.id === 'logoutModal') {
                            closeLogoutModal();
                        }
                    }
                });
            });
            
            // Validation en temps r√©el du num√©ro Mobile Money
            const accountDetailsInput = document.getElementById('accountDetails');
            if (accountDetailsInput) {
                accountDetailsInput.addEventListener('input', function() {
                    const value = this.value.replace(/[^0-9]/g, '');
                    this.value = value;
                    
                    // Validation visuelle
                    const phoneRegex = /^[0-9]{8,12}$/;
                    if (value && !phoneRegex.test(value)) {
                        this.style.borderColor = 'var(--secondary)';
                        this.style.boxShadow = '0 0 0 3px rgba(255, 107, 107, 0.2)';
                    } else {
                        this.style.borderColor = '';
                        this.style.boxShadow = '';
                    }
                });
            }

            // Forcer le chargement initial du badge et configurer la synchronisation
            setTimeout(() => {
                if (window.auth && window.auth.currentUser) {
                    console.log("‚ö° Forcer le chargement du badge pour l'utilisateur connect√©");
                    window.updateNotificationBadge(window.auth.currentUser.uid);
                    setupNotificationSync();
                }
            }, 1500);
        });
    </script>
</body>
</html>